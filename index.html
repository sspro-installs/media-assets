<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SSPro Media Assets Library</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --card:#1e293b;
      --muted:#94a3b8; --brand:#22c55e; --link:#93c5fd;
      --ring:rgba(34,197,94,.45);
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);color:#f8fafc;margin:0;padding:24px;
    }
    header{max-width:1200px;margin:0 auto 20px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{font-size:28px;color:var(--brand);margin:0}
    .hint{color:var(--muted);font-size:14px}
    main{max-width:1200px;margin:0 auto}
    details{background:var(--panel);border:1px solid #1f2937;border-radius:14px;margin:14px 0;overflow:hidden}
    summary{list-style:none;cursor:pointer;padding:14px 16px;font-weight:700;display:flex;align-items:center;gap:10px}
    summary::-webkit-details-marker{display:none}
    .chev{display:inline-block;transition:transform .18s ease}
    details[open] .chev{transform:rotate(90deg)}
    .pill{background:#102038;border:1px solid #20324a;border-radius:999px;padding:2px 8px;font-size:11px;color:#9bb0cc}
    .subgroup{margin:8px 14px 18px;border:1px dashed #243041;border-radius:12px;overflow:hidden}
    .sub-head{display:flex;align-items:center;gap:8px;cursor:pointer;padding:10px 12px;background:#0b1220;color:#cbd5e1;font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;padding:12px;background:linear-gradient(180deg,#0b1220,#0a1322)}
    .card{background:var(--card);border-radius:12px;padding:8px;text-align:center;transition:transform .18s ease,box-shadow .18s ease;position:relative}
    .card:hover{transform:translateY(-3px);box-shadow:0 6px 18px var(--ring)}
    .thumb{width:100%;height:120px;object-fit:contain;background:#0f172a;border-radius:8px}
    .fname{margin-top:6px;font-size:12px;color:var(--link);word-break:break-all;text-decoration:none;display:inline-block;line-height:1.2;cursor:pointer}
    .fname:hover{text-decoration:underline;color:#60a5fa}
    .copy{position:absolute;right:8px;top:8px;font-size:11px;padding:3px 6px;border-radius:8px;border:1px solid #324058;background:#0b1220;color:#d1d5db;cursor:pointer}
    .copy.ok{background:#0c3b1f;border-color:#14532d;color:#86efac}
    footer{max-width:1200px;margin:22px auto 0;color:var(--muted);font-size:12px;text-align:center}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid #1f2937;border-top-color:var(--brand);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .muted{color:var(--muted)}
    .toast{
      position:fixed;bottom:20px;right:20px;background:#14532d;color:#bbf7d0;
      padding:8px 14px;border-radius:8px;font-size:13px;box-shadow:0 0 12px rgba(0,0,0,.3);
      opacity:0;pointer-events:none;transition:opacity .3s,transform .3s;
      transform:translateY(10px);
    }
    .toast.show{opacity:1;transform:translateY(0)}
    #refresh{
      background:#22c55e;color:#fff;padding:6px 12px;border:none;border-radius:8px;cursor:pointer;
      transition:background .2s ease;margin-bottom:10px;
    }
    #refresh:hover{background:#16a34a}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“¦ SSPro Media Assets Library</h1>
    <div class="hint">Auto-discovered â€¢ Click folders to expand â€¢ Click name or button to copy URL</div>
  </header>

  <button id="refresh">ðŸ”„ Refresh</button>

  <main id="app" aria-live="polite">
    <div class="row muted" style="gap:10px;"><div class="spinner"></div> Loading foldersâ€¦</div>
  </main>

  <div id="toast" class="toast"></div>
  <footer>Hosted on GitHub Pages â€” <span class="muted">sspro-installs/media-assets</span></footer>

<script>
const OWNER="sspro-installs",REPO="media-assets",BRANCH="main";
const API_BASE=`https://api.github.com/repos/${OWNER}/${REPO}/contents`;
const RAW_BASE=`https://sspro-installs.github.io/${REPO}`; // use Pages not raw.githubusercontent
const IMAGE_EXTS=['.png','.jpg','.jpeg','.gif','.svg','.webp','.avif'];
const isImage=(n)=>IMAGE_EXTS.some(e=>n.toLowerCase().endsWith(e));
const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));

const cache={
  get(k){try{return JSON.parse(sessionStorage.getItem(k))}catch{return null}},
  set(k,v){try{sessionStorage.setItem(k,JSON.stringify(v))}catch{}}
};

async function fetchDir(p=""){
  const key=`dir:${p||"/"}`;
  const cached=cache.get(key);
  // ðŸŸ© Allow bypass with ?refresh in URL
  if(cached && !location.search.includes("refresh")) return cached;
  const url=`${API_BASE}/${encodeURIComponent(p)}?ref=${BRANCH}`;
  const r=await fetch(url,{headers:{"Accept":"application/vnd.github.v3+json"}});
  if(!r.ok)throw new Error(`GitHub API ${r.status} for ${p||"/"}`);
  const d=await r.json();
  cache.set(key,d);
  return d;
}

async function buildTree(root=""){
  const e=await fetchDir(root),dirs=[],imgs=[];
  for(const i of e){
    if(i.name==='.DS_Store'||i.name==='index.html')continue;
    if(i.type==='dir')dirs.push(i);
    else if(i.type==='file'&&isImage(i.name))
      imgs.push({name:i.name,path:i.path,raw:`${RAW_BASE}/${i.path}`});
  }
  const children=[];
  for(const d of dirs){
    try{
      children.push({name:d.name,path:d.path,...(await buildTree(d.path))});
      await sleep(150); // ðŸŸ© increased delay for reliability
    }catch(err){
      console.warn("Retrying folder",d.path);
      await sleep(300);
      children.push({name:d.name,path:d.path,...(await buildTree(d.path))});
    }
  }
  return{images:imgs,folders:children};
}

function renderApp(tree){
  const app=document.getElementById('app');
  app.innerHTML="";
  if(tree.images?.length)app.appendChild(renderPrimary("root",tree));
  for(const top of tree.folders)app.appendChild(renderPrimary(top.name,top));
}

function renderPrimary(title,node){
  const wrap=document.createElement('details');
  const sum=document.createElement('summary');
  sum.innerHTML=`<span class="chev">â–¶</span><span style="font-size:18px">${title}</span><span class="pill">${countImages(node)} images</span>`;
  wrap.appendChild(sum);
  if(node.images?.length)wrap.appendChild(renderGrid(node.images));
  for(const sub of node.folders)wrap.appendChild(renderSecondary(`${title} â€º ${sub.name}`,sub));
  return wrap;
}

function renderSecondary(label,node){
  const block=document.createElement('div');block.className="subgroup";
  const head=document.createElement('div');
  head.className="sub-head";
  head.innerHTML=`<span class="chev">â–¶</span><span>${label}</span><span class="pill">${countImages(node)} images</span>`;
  block.appendChild(head);
  const grid=renderGrid(node.images);grid.style.display="none";block.appendChild(grid);
  head.addEventListener('click',()=>{
    const open=grid.style.display!=="none";
    grid.style.display=open?"none":"grid";
    head.querySelector('.chev').style.transform=open?"rotate(0deg)":"rotate(90deg)";
  });
  for(const deeper of node.folders){
    const nested=renderSecondary(`${label} â€º ${deeper.name}`,deeper);
    nested.style.display="none";block.appendChild(nested);
    head.addEventListener('click',()=>{nested.style.display=grid.style.display;});
  }
  return block;
}

function renderGrid(files){
  const grid=document.createElement('div');grid.className="grid";
  files.sort((a,b)=>a.name.localeCompare(b.name));
  files.forEach(f=>{
    const card=document.createElement('div');card.className="card";
    const img=document.createElement('img');img.className="thumb";img.loading="lazy";img.src=f.raw;img.alt=f.name;
    const a=document.createElement('a');a.className="fname";a.textContent=f.name;a.href=f.raw;a.target="_blank";
    a.addEventListener('click',async e=>{
      e.preventDefault();
      await copyUrl(f.raw);
    });
    const btn=document.createElement('button');
    btn.className="copy";btn.textContent="Copy";
    btn.addEventListener('click',()=>copyUrl(f.raw,btn));
    card.append(img,a,btn);grid.appendChild(card);
  });
  if(!files.length){
    const p=document.createElement('p');
    p.className="muted";p.style.padding="12px";
    p.textContent="No images in this folder.";
    grid.appendChild(p);
  }
  return grid;
}

async function copyUrl(url,btn){
  try{
    await navigator.clipboard.writeText(url);
    if(btn){
      btn.textContent="Copied";
      btn.classList.add("ok");
      setTimeout(()=>{btn.textContent="Copy";btn.classList.remove("ok")},1000);
    }
    showToast("âœ… Copied: "+url.split("/").pop());
  }catch{if(btn)btn.textContent="Failed";}
}

function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1500);
}

function countImages(n){
  let c=n.images?.length||0;
  for(const f of n.folders||[])c+=countImages(f);
  return c;
}

// ðŸŸ© Refresh button clears cache
document.getElementById("refresh").onclick=()=>{
  sessionStorage.clear();
  location.reload();
};

(async function init(){
  const app=document.getElementById('app');
  try{
    const tree=await buildTree("");
    renderApp(tree);
  }catch(e){
    console.error(e);
    app.innerHTML=`<div style="padding:12px;border:1px solid #3f1d1d;background:#1a0f0f;border-radius:12px">
      <strong style="color:#fecaca">Failed.</strong>
      <div class="muted">${e.message}</div>
    </div>`;
  }
})();
</script>
</body>
</html>
